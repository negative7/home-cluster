---
- name: Create CoreDns Home directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: 0755
  loop:
    - /mnt/data/coredns-workdir

- name: Install Coredns
  block:
    - name: Pull an image
      containers.podman.podman_image:
        name: ghcr.io/k8s-at-home/coredns:{{ coredns_version }}
    - name: Remove a Coredns
      containers.podman.podman_container:
        name: coredns
        state: absent
    - name: Create Coredns startup script
      ansible.builtin.template:
        src: 53-onboot-coredns.j2
        dest: /mnt/data/on_boot.d/53-onboot-coredns.sh
        mode: 0755
    - name: Create coredns startup script
      ansible.builtin.template:
        src: 53-coredns.j2
        dest: /mnt/data/on_boot.d/53-coredns.sh
        mode: 0755
    - name: Create dns config
      ansible.builtin.template:
        src: 53-coredns.conflist.j2
        dest: /mnt/data/podman/cni/53-coredns.conflist
        mode: 0755
    - name: Create onboot script
      ansible.builtin.template:
        src: Corefile.j2
        dest: /mnt/data/coredns-workdir/Corefile
        mode: 0755
    - name: Copy kubeconfig
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/../../kubernetes/kubeconfig"
        dest: /mnt/data/coredns-workdir/kubeconfig
    - name: Start Coredns
      ansible.builtin.command: "/mnt/data/on_boot.d/53-coredns.sh"
      failed_when: false
      changed_when: false
    - name: Start Coredns
      ansible.builtin.command: "/mnt/data/on_boot.d/53-onboot-coredns.sh"
      failed_when: false
      changed_when: false
