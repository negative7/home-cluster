---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: traefik
  namespace: kube-system
spec:
  interval: 5m
  chart:
    spec:
      chart: traefik
      interval: 5m
      sourceRef:
        kind: HelmRepository
        name: traefik-charts
        namespace: flux-system
      version: 9.19.0
  values:
    #deployment:
      # initContainers:
      #   # The "volume-permissions" init container is required if you run into permission issues.
      #   # Related issue: https://github.com/containous/traefik/issues/6972
      #   - name: volume-permissions
      #     image: busybox:1.31.1
      #     command: ["sh", "-c", "chmod -Rv 600 /data/*"]
      #     volumeMounts:
      #       - name: data
      #         mountPath: /data
    logs:
      general: DEBUG
      access:
        enabled: true
    persistence:
      enabled: false
      path: /certs
      size: 128Mi
      # storageClass: "longhorn"
      accessMode: ReadWriteMany
      annotations: {
        "pv.beta.kubernetes.io/gid": "65532"
      }
    volumes:
      - mountPath: /data
        name: "traefik-config"
        type: configMap
    additionalArguments:
      - --providers.file.filename=/data/traefik-config.yaml
      - --api.dashboard
      - --api.insecure
      - --api.debug
      - --serversTransport.insecureSkipVerify=true
      - --entryPoints.web.forwardedHeaders.insecure
      # - --entrypoints.websecure.http.tls.certresolver=lets-prod
      # - --entrypoints.websecure.http.tls.domains[0].main=home.negative7.com
      # - --entrypoints.websecure.http.tls.domains[0].sans=*.home.negative7.com
      # - --certificatesresolvers.lets-prod.acme.email=admin@negative7.com
      # - --certificatesresolvers.lets-prod.acme.storage=/certs/acme.json
      # - --certificatesresolvers.lets-prod.acme.dnschallenge=true
      # - --certificatesresolvers.lets-prod.acme.dnschallenge.provider=cloudflare
#      - --providers.file.filename=/data/traefik-config.yaml
    #https://github.com/traefik/traefik-helm-chart/issues/164
    service:
      type: LoadBalancer
      loadBalancerIP: "${INGRESS_TRAEFIK_LB}"
      externalTrafficPolicy: Local
